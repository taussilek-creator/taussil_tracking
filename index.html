<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Fahrer Verfolgung<<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Fahrer Verfolgung</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Arial;margin:0;background:#fafafa}
    /* (3)(7) Ø§Ù„Ø®Ø±ÙŠØ·Ø©: Ø¥Ø²Ø§Ø­Ø© 15px Ù„Ù„Ø£Ø³ÙÙ„ ÙˆØ§Ù„ÙŠØ³Ø§Ø± + Ø²ÙˆØ§ÙŠØ§ 15px */
    #map{
      height:70vh; width:70%; background:#eee;
      position:relative; border-radius:15px; overflow:hidden;
      transform: translate(-15px,15px);
    }

    /* (4) Ø²Ø± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙÙˆÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
    .toolbar-overlay{
      position:absolute; z-index:3; top:16px; left:24px; display:flex; gap:8px; pointer-events:auto;
    }
    .select{
      padding:6px 10px;border:1px solid #ccc;border-radius:8px;background:#fff;cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.2);
    }

    .panel{padding:12px}
    .pill{padding:6px 10px;border:1px solid #ddd;border-radius:8px;margin:4px;display:inline-flex;align-items:center;gap:6px}
    .eta{font-weight:700}

    /* (5) Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ankunftszeit Ø¨Ø¯ÙˆÙ† Ø¥Ø·Ø§Ø± + GIF */
    .statusInline{display:inline-flex;align-items:center;gap:8px;margin:4px 6px;padding:6px 0;vertical-align:middle}
    #statusIcon{width:32px;height:32px;display:none}

    /* (6) Ø£Ø®Ø¶Ø± â‰¤ 6 Ø¯Ù‚Ø§Ø¦Ù‚ + Ù†Ø¨Ø¶ â‰¤ 60 Ø«Ø§Ù†ÙŠØ© */
    #etaPill.green { background:#e6f7ec; border-color:#b7e3c7; color:#116b2c; }
    #etaPill.blink { animation: bl 1s linear infinite; }
    @keyframes bl { 0%{opacity:1} 50%{opacity:.45} 100%{opacity:1} }

    /* (8) Ù„ÙˆØ¬Ùˆ Ø§Ù„Ø´Ø±ÙƒØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
    .brandLogo{
      position:absolute; z-index:2; width:96px; height:auto;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.25));
      user-select:none; pointer-events:none; display:none;
    }
    .brandLogo.tl{ top:14px; left:14px; }
    .brandLogo.bl{ bottom:14px; left:14px; }
  </style>
</head>
<body>
  <div id="map">
    <!-- (4) Ù…Ø¨Ø¯Ù‘Ù„ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ø¢Ù…Ù† Ù„Ùˆ Ø­ÙØ°Ù) -->
    <div class="toolbar-overlay">
      <select id="mapType" class="select" title="Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©">
        <option value="roadmap">Roadmap</option>
        <option value="satellite">Satellite</option>
        <option value="terrain">Terrain</option>
        <option value="hybrid">Hybrid</option>
      </select>
    </div>
    <!-- (8) Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
    <img id="brandLogo" class="brandLogo tl" alt="logo">
  </div>

  <div class="panel">
    <div class="pill">Fahrt: <span id="distance">â€”</span></div>
    <div id="etaPill" class="pill eta">Ankunftszeit: <span id="countdown">â€”</span></div>
    <!-- (5) Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø³Ø·Ø± Ø¨Ø¯ÙˆÙ† Ø¥Ø·Ø§Ø± -->
    <div class="statusInline">
      <img id="statusIcon" alt="status">
      <span id="statusText">â€”</span>
    </div>
  </div>

  <!-- Ø§Ù„Ø£ØµÙˆØ§Øª (ÙƒÙ…Ø§ Ù‡ÙŠ) -->
  <audio id="soundAccept" src="unterwegs.mp3" preload="auto"></audio>
  <audio id="soundOneMinute" src="angekommen.mp3" preload="auto"></audio>

  <script>
    /* ================= Firebase ================= */
    var firebaseConfig = {
      apiKey: "AIzaSyCUiy2nF3V_Z4V3k0MbfyRGuGoBBp6uACE",
      authDomain: "taussil-tracking.firebaseapp.com",
      databaseURL: "https://taussil-tracking-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "taussil-tracking",
      storageBucket: "taussil-tracking.firebasestorage.app",
      messagingSenderId: "733589615357",
      appId: "1:733589615357:web:1926206637b7af263ac494"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    /* ================= Helpers (Ù…Ù†Ø·Ù‚Ùƒ) ================= */
    function parseLatLng(str){
      if(!str) return null;
      var p = String(str).split(",");
      if(p.length!==2) return null;
      var lat = parseFloat(p[0].trim());
      var lng = parseFloat(p[1].trim());
      if(isNaN(lat)||isNaN(lng)) return null;
      return {lat:lat, lng:lng};
    }
    function normalizeStatus(s){
      if(!s) return "";
      s = String(s).trim().toLowerCase();
      if(s==="bearbeitung" || s==="processing" || s==="pending") return "bearbeitung";
      if(s==="unterwegs" || s==="accepted" || s==="on the way" || s==="on_the_way") return "unterwegs";
      if(s==="geliefert" || s==="delivered") return "geliefert";
      return s;
    }
    function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /* ================= ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠ + fallback ================= */
    var audioArmed = false;
    function tryPlay(id){ var el=document.getElementById(id); if(!el) return Promise.resolve(); el.currentTime=0; return el.play(); }
    function autoSound(id){
      tryPlay(id).catch(function(){
        if (audioArmed) return;
        audioArmed = true;
        var once = function(){ tryPlay(id).catch(()=>{}); window.removeEventListener('pointerdown', once); window.removeEventListener('keydown', once); window.removeEventListener('touchstart', once); };
        window.addEventListener('pointerdown', once, {once:true});
        window.addEventListener('keydown', once, {once:true});
        window.addEventListener('touchstart', once, {once:true, passive:true});
      });
    }

    /* ================= UI refs ================= */
    var distanceEl, countdownEl, etaPillEl, statusTextEl, statusIconEl;

    /* ================= Map / Route ================= */
    var map, driverMarker, destMarker, fitOnce=false;
    var directionsService, directionsRenderer;
    var lastDriverPos=null, driverInfo=null, restInfo=null;

    /* (1) Ø³ØªØ§ÙŠÙ„ Ø®Ø±ÙŠØ·Ø© Ø£Ø­Ø§Ø¯ÙŠ + Ø·Ø±Ù‚ Ø±Ù…Ø§Ø¯ÙŠØ© + Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´ÙˆØ§Ø±Ø¹ */
    var baseStyle = [
      { elementType:"geometry", stylers:[{ color:"#f5f5f5" }] },
      { elementType:"labels.icon", stylers:[{ visibility:"off" }] },
      { featureType:"poi", stylers:[{ visibility:"off" }] },
      { featureType:"transit", stylers:[{ visibility:"off" }] },
      { featureType:"administrative", elementType:"labels", stylers:[{ visibility:"off" }] },
      { featureType:"water", elementType:"geometry.fill", stylers:[{ color:"#d6e8ff" }] },
      { featureType:"road", elementType:"geometry", stylers:[{ color:"#cfcfcf" }] },
      { featureType:"road", elementType:"geometry.stroke", stylers:[{ color:"#b9b9b9" }] },
      { featureType:"road", elementType:"labels.text.fill", stylers:[{ color:"#4a4a4a" }] },
      { featureType:"road", elementType:"labels.text.stroke", stylers:[{ color:"#ffffff" }] }
    ];

    /* (9) Ø³Ù‡Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ + Ø­Ø±ÙƒØ© Ø§Ù†Ø³ÙŠØ§Ø¨ÙŠØ© */
    function makeArrowIcon(rotationDeg){
      return {
        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
        scale: 5,
        strokeWeight: 2,
        strokeColor: "#1a73e8",
        fillColor: "#1a73e8",
        fillOpacity: 1,
        rotation: rotationDeg || 0,
        anchor: new google.maps.Point(0, 2)
      };
    }
    function bearing(from, to){
      var dLon=(to.lng-from.lng)*Math.PI/180, lat1=from.lat*Math.PI/180, lat2=to.lat*Math.PI/180;
      var y=Math.sin(dLon)*Math.cos(lat2);
      var x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
      var brng=Math.atan2(y,x)*180/Math.PI;
      return (brng+360)%360;
    }
    function tween(a,b,t){ return a+(b-a)*t; }
    function smoothMoveArrow(marker, from, to, ms=350){
      if(!from){ marker.setPosition(to); marker.setIcon(makeArrowIcon()); return; }
      var head=bearing(from,to); const t0=performance.now();
      function step(now){
        const k=Math.min(1,(now-t0)/ms);
        const pos={lat:tween(from.lat,to.lat,k), lng:tween(from.lng,to.lng,k)};
        marker.setPosition(pos); marker.setIcon(makeArrowIcon(head));
        if(k<1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    /* ================= Countdown & Status (ÙƒÙ…Ø§ Ù‡Ùˆ) ================= */
    var countdownTimer=null, remaining=null, oneMinuteWarned=false;
    var prevStatusNorm=null, deliveryActive=false;
    var EXTRA_SECONDS = 180;
    var serverOffsetMs = 0;
    var etaTargetMs = null;
    var orderId = null;

    db.ref(".info/serverTimeOffset").on("value", function(snap){
      var v = snap.val(); serverOffsetMs = (typeof v === "number") ? v : 0;
    });
    function nowServerMs(){ return Date.now() + serverOffsetMs; }

    function storageKey(){ return "etaTarget_"+orderId; }
    function saveEtaTarget(ms){ etaTargetMs = ms; try{ localStorage.setItem(storageKey(), String(ms)); }catch(e){} }
    function loadEtaTarget(){ try{ var v=localStorage.getItem(storageKey()); if(v){ etaTargetMs=parseInt(v,10); if(isNaN(etaTargetMs)) etaTargetMs=null; } }catch(e){} }
    function clearEtaTarget(){ etaTargetMs=null; try{ localStorage.removeItem(storageKey()); }catch(e){} }

    function resetCountdownUI(){
      if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; }
      remaining=null; oneMinuteWarned=false; etaTargetMs=null; clearEtaTarget();
      if(countdownEl) countdownEl.textContent="â€”";
      if(etaPillEl){ etaPillEl.classList.remove('green'); etaPillEl.classList.remove('blink'); }
    }

    function serverEtaMsFromSnapshot(v){
      if(v && v.Arrival_Timestamp != null){
        if(typeof v.Arrival_Timestamp === 'number'){
          var n=v.Arrival_Timestamp, ms=(n>1e12)?n:n*1000; return ms + EXTRA_SECONDS*1000;
        }
        if(typeof v.Arrival_Timestamp === 'string'){
          var t=Date.parse(v.Arrival_Timestamp); if(!isNaN(t)) return t + EXTRA_SECONDS*1000;
        }
      }
      if(v && typeof v.Ankunft_Seconds_Raw === 'number'){
        return nowServerMs() + (v.Ankunft_Seconds_Raw + EXTRA_SECONDS)*1000;
      }
      if(v && typeof v.DurationValue === 'number'){
        return nowServerMs() + (v.DurationValue + EXTRA_SECONDS)*1000;
      }
      return null;
    }

    var ETA_IMPROVE_THRESHOLD_MS = 15000;
    function updateEtaNoIncrease(newEtaMs){
      if(newEtaMs == null) return;
      if(etaTargetMs == null){ saveEtaTarget(newEtaMs); startOrUpdateCountdownFromTarget(); return; }
      var diff=newEtaMs-etaTargetMs;
      if(diff < -ETA_IMPROVE_THRESHOLD_MS){ saveEtaTarget(newEtaMs); startOrUpdateCountdownFromTarget(); }
    }

    function startOrUpdateCountdownFromTarget(){
      if(!deliveryActive || !etaTargetMs) return;
      if(countdownTimer) clearInterval(countdownTimer);
      function tick(){
        var rem = Math.floor((etaTargetMs - nowServerMs())/1000);
        remaining = Math.max(0, rem);
        if(remaining <= 360) etaPillEl.classList.add('green'); else etaPillEl.classList.remove('green');
        if(remaining <= 60){
          if(!oneMinuteWarned){ oneMinuteWarned = true; autoSound("soundOneMinute"); }
          etaPillEl.classList.add('blink');
        } else { etaPillEl.classList.remove('blink'); }
        renderCountdown();
        if(remaining <= 0){ clearInterval(countdownTimer); countdownTimer=null; }
      }
      tick(); countdownTimer=setInterval(tick,1000);
    }

    function renderCountdown(){
      if(remaining==null){ countdownEl.textContent="â€”"; return; }
      var m=Math.floor(remaining/60), s=remaining%60;
      countdownEl.textContent = m + ":" + (s<10?("0"+s):s);
    }

    function routeIfNeeded(origin, destination){
      if(!origin||!destination) return;
      directionsService.route({ origin, destination, travelMode:'DRIVING' }, function(result, status){
        if(status==='OK'){ directionsRenderer.setDirections(result); }
      });
    }

    /* (5) Ù…Ø³Ø§Ø±Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„Ø© (Ø¨Ø¯Ù‘Ù„Ù‡Ø§ Ø¨Ù…Ù„ÙØ§ØªÙƒ) */
    var STATUS_GIFS = {
      bearbeitung: "warten.gif",
      unterwegs:   "ziel.gif",
      geliefert:   "verifiziert.gif"
    };

    /* ================= initMap ================= */
    function initMap(){
      distanceEl  = document.getElementById("distance");
      countdownEl = document.getElementById("countdown");
      etaPillEl   = document.getElementById("etaPill");
      statusTextEl= document.getElementById("statusText");
      statusIconEl= document.getElementById("statusIcon");

      /* Ø®Ø±ÙŠØ·Ø© Ø¨Ø³ØªØ§ÙŠÙ„ Ø£Ø­Ø§Ø¯ÙŠ + Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± (2) + Ø²Ø± Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© (11) */
      map = new google.maps.Map(document.getElementById("map"), {
        zoom:14, center:{lat:52.52, lng:13.40},
        styles: baseStyle,
        mapTypeControl:false,
        streetViewControl:false,
        fullscreenControl:true,
        rotateControl:false,
        scaleControl:true,
        zoomControl:false
      });

      /* (4) Ù…Ø¨Ø¯Ù‘Ù„ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© â€” Ø¢Ù…Ù† Ù„Ùˆ Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ */
      var sel = document.getElementById('mapType');
      if (sel) {
        sel.addEventListener('change', function(){
          map.setMapTypeId(this.value);
          if (this.value === 'roadmap') { map.setOptions({styles: baseStyle}); }
          else { map.setOptions({styles: null}); }
        });
        sel.value = 'roadmap';
      }

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers:true,
        polylineOptions:{ strokeColor:"#4285F4", strokeOpacity:0.8, strokeWeight:2 }
      });
      directionsRenderer.setMap(map);

      /* (8) Ø§Ù„Ù„ÙˆØ¬Ùˆ Ù…Ù† Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ±Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø· â€” Ø¢Ù…Ù† Ù„Ùˆ Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ */
      var params = new URLSearchParams(window.location.search);
      var logoEl = document.getElementById('brandLogo');
      if (logoEl) {
        var logoSrc = params.get('logo');
        var logoPos = (params.get('logoPos')||'tl').toLowerCase(); // tl / bl
        if (logoSrc) {
          logoEl.src = logoSrc;
          logoEl.classList.toggle('tl', logoPos!=='bl');
          logoEl.classList.toggle('bl', logoPos==='bl');
          logoEl.style.display = 'block';
        }
      }

      /* â€”â€”â€”â€” Ù†ÙØ³ Ù…Ù†Ø·Ù‚Ùƒ Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù€ orderId â€”â€”â€”â€” */
      orderId = params.get("orderId");
      if(!orderId){ alert("âš  Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± orderId ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·"); return; }

      // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù‡Ø¯Ù Ø³Ø§Ø¨Ù‚ (Ø¥Ù† ÙˆÙØ¬Ø¯) Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
      loadEtaTarget();

      var ref = db.ref("orders/" + orderId);
      ref.on("value", function(snap){
        var v = snap.val();
        if(!v) return;

        if(v.DistanceText) distanceEl.textContent = v.DistanceText;

        // (5) Ø§Ù„Ø­Ø§Ù„Ø© + GIF (ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·)
        var cur = normalizeStatus(v.Status);
        if(cur === "bearbeitung"){
          statusTextEl.textContent = "Bearbeitung";
          statusIconEl.src = STATUS_GIFS.bearbeitung; statusIconEl.style.display="inline";
        } else if(cur === "unterwegs"){
          statusTextEl.textContent = "Unterwegs";
          statusIconEl.src = STATUS_GIFS.unterwegs; statusIconEl.style.display="inline";
          if(prevStatusNorm !== "unterwegs") autoSound("soundAccept");
        } else if(cur === "geliefert"){
          statusTextEl.textContent = "Geliefert";
          statusIconEl.src = STATUS_GIFS.geliefert; statusIconEl.style.display="inline";
        } else {
          statusTextEl.textContent = cur || "â€”";
          statusIconEl.style.display="none";
        }

        // â€”â€”â€”â€” Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø¹Ø¯Ù‘Ø§Ø¯ â€”â€”â€”â€”
        if(cur === "unterwegs" && prevStatusNorm !== "unterwegs"){
          deliveryActive = true;
          autoSound("soundAccept");
          var firstEta = serverEtaMsFromSnapshot(v);
          if(etaTargetMs){ updateEtaNoIncrease(firstEta); } else { updateEtaNoIncrease(firstEta); }
          startOrUpdateCountdownFromTarget();

        } else if(cur === "bearbeitung" && prevStatusNorm !== "bearbeitung"){
          deliveryActive = false; resetCountdownUI();
        }
        prevStatusNorm = cur;

        if(deliveryActive){
          var liveEta = serverEtaMsFromSnapshot(v);
          updateEtaNoIncrease(liveEta);
        }

        // Ù…ÙˆØ§Ù‚Ø¹ + Ø±Ø³Ù…
        var dest = parseLatLng(v.Destination);
        var drv  = parseLatLng(v.DriverLocation);

        // (10) Ø§Ù„Ù…Ø·Ø¹Ù…: Ø§Ø³Ù… + ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§ Ø¹Ù†Ø¯ hover
        if(dest){
          if(!destMarker){
            destMarker = new google.maps.Marker({
              position: dest, map: map,
              icon: { url: "7720549.png", scaledSize: new google.maps.Size(28,28), anchor: new google.maps.Point(14,28) },
              title: v.RestaurantName || "Restaurant"
            });
            restInfo = new google.maps.InfoWindow({content:""});
            let to;
            destMarker.addListener('mouseover', ()=>{
              var restName = esc(v.RestaurantName || "Restaurant");
              var restLogo = v.RestaurantLogo ? '<br><img src="'+esc(v.RestaurantLogo)+'" style="width:60px;height:60px;border-radius:8px;margin-top:6px">' : "";
              restInfo.setContent('<div style="text-align:center"><strong>'+restName+'</strong>'+restLogo+'</div>');
              restInfo.open(map, destMarker);
            });
            destMarker.addListener('mouseout', ()=>{ to && clearTimeout(to); to=setTimeout(()=>restInfo.close(), 150); });
          } else destMarker.setPosition(dest);
        }

        // (9)(10) Ø§Ù„Ø³Ø§Ø¦Ù‚: Ø³Ù‡Ù… Ø¨Ø­Ø±ÙƒØ© Ø³Ù„Ø³Ø© + Ø§Ø³Ù… ÙÙ‚Ø· Ø¹Ù†Ø¯ hover
        if(drv){
          if(!driverMarker){
            driverMarker = new google.maps.Marker({
              position: drv, map: map,
              icon: makeArrowIcon(0),
              title: v.DriverName || "Fahrer"
            });
            driverInfo = new google.maps.InfoWindow({content:""});
            let to2;
            driverMarker.addListener('mouseover', ()=>{
              var drvName = esc(v.DriverName || "Fahrer");
              driverInfo.setContent('<div><strong>'+drvName+'</strong></div>');
              driverInfo.open(map, driverMarker);
            });
            driverMarker.addListener('mouseout', ()=>{ to2 && clearTimeout(to2); to2=setTimeout(()=>driverInfo.close(), 150); });
            lastDriverPos = drv;
          } else {
            var from = lastDriverPos || driverMarker.getPosition().toJSON();
            smoothMoveArrow(driverMarker, from, drv, 350);
            lastDriverPos = drv;
          }
          map.panTo(lastDriverPos);
        }

        if(dest && drv){
          if(!fitOnce){
            var b=new google.maps.LatLngBounds(); b.extend(dest); b.extend(drv); map.fitBounds(b); fitOnce=true;
          }
          routeIfNeeded(drv, dest);
        }
      });
    }
    window.initMap = initMap;
  </script>

  <!-- Google Maps -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDipzUmxEQmAjaDkn6xQ91ZhqnkPmgl-2o&loading=async&callback=initMap"></script>
</body>
</html>/title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Arial;margin:0}
    #map{height:70vh;width:100%;background:#eee}
    .panel{padding:12px}
    .pill{padding:6px 10px;border:1px solid #ddd;border-radius:8px;margin:4px;display:inline-block}
    .eta{font-weight:700}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="panel">
    <div class="pill">Fahrt: <span id="distance">â€”</span></div>
    <div class="pill eta">Ankunftszeit: <span id="countdown">â€”</span></div>
  </div>

  <!-- Ø§Ù„Ø£ØµÙˆØ§Øª -->
  <audio id="soundAccept" src="unterwegs.mp3" preload="auto"></audio>
  <audio id="soundOneMinute" src="angekommen.mp3" preload="auto"></audio>

  <script>
    /* ================= Firebase ================= */
    var firebaseConfig = {
      apiKey: "AIzaSyCUiy2nF3V_Z4V3k0MbfyRGuGoBBp6uACE",
      authDomain: "taussil-tracking.firebaseapp.com",
      databaseURL: "https://taussil-tracking-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "taussil-tracking",
      storageBucket: "taussil-tracking.firebasestorage.app",
      messagingSenderId: "733589615357",
      appId: "1:733589615357:web:1926206637b7af263ac494"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    /* ================= Helpers ================= */
    function parseLatLng(str){
      if(!str) return null;
      var p = String(str).split(",");
      if(p.length!==2) return null;
      var lat = parseFloat(p[0].trim());
      var lng = parseFloat(p[1].trim());
      if(isNaN(lat)||isNaN(lng)) return null;
      return {lat:lat, lng:lng};
    }
    function normalizeStatus(s){
      if(!s) return "";
      s = String(s).trim().toLowerCase();
      if(s==="bearbeitung" || s==="processing" || s==="pending") return "bearbeitung";
      if(s==="unterwegs" || s==="accepted" || s==="on the way" || s==="on_the_way") return "unterwegs";
      return s;
    }

    /* ================= ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠ + fallback Ù„Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„ ================= */
    var audioArmed = false;
    function tryPlay(id){
      var el = document.getElementById(id);
      if(!el) return Promise.resolve();
      el.currentTime = 0;
      return el.play();
    }
    function autoSound(id){
      tryPlay(id).catch(function(){
        if (audioArmed) return;
        audioArmed = true;
        var once = function(){
          tryPlay(id).catch(()=>{});
          window.removeEventListener('pointerdown', once);
          window.removeEventListener('keydown', once);
          window.removeEventListener('touchstart', once);
        };
        window.addEventListener('pointerdown', once, {once:true});
        window.addEventListener('keydown', once, {once:true});
        window.addEventListener('touchstart', once, {once:true, passive:true});
      });
    }

    /* ================= UI refs ================= */
    var distanceEl, countdownEl;

    /* ================= Map / Route ================= */
    var map, driverMarker, destMarker, fitOnce=false;
    var directionsService, directionsRenderer;

    /* ================= Countdown & Status (Ù‡Ø¯Ù ÙˆØµÙˆÙ„ Ù…Ø­ÙÙˆØ¸) ================= */
    var countdownTimer=null, remaining=null, oneMinuteWarned=false;
    var prevStatusNorm=null, deliveryActive=false;
    var EXTRA_SECONDS = 180; // +3 Ø¯Ù‚Ø§Ø¦Ù‚
    var serverOffsetMs = 0;
    var etaTargetMs = null;
    var orderId = null;

    // ØªØµØ­ÙŠØ­ ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨ÙˆÙ‚Øª Ø§Ù„Ø³ÙŠØ±ÙØ±
    db.ref(".info/serverTimeOffset").on("value", function(snap){
      var v = snap.val();
      serverOffsetMs = (typeof v === "number") ? v : 0;
    });
    function nowServerMs(){ return Date.now() + serverOffsetMs; }

    // ØªØ®Ø²ÙŠÙ†/Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù‡Ø¯Ù Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„ÙƒÙ„ orderId
    function storageKey(){ return "etaTarget_"+orderId; }
    function saveEtaTarget(ms){
      etaTargetMs = ms;
      try{ localStorage.setItem(storageKey(), String(ms)); }catch(e){}
    }
    function loadEtaTarget(){
      try{
        var v = localStorage.getItem(storageKey());
        if(v){ etaTargetMs = parseInt(v,10); if(isNaN(etaTargetMs)) etaTargetMs = null; }
      }catch(e){}
    }
    function clearEtaTarget(){
      etaTargetMs = null;
      try{ localStorage.removeItem(storageKey()); }catch(e){}
    }

    function resetCountdownUI(){
      if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; }
      remaining=null; oneMinuteWarned=false;
      etaTargetMs=null; clearEtaTarget();
      if(countdownEl) countdownEl.textContent="â€”";
    }

    // Ø­Ø³Ø§Ø¨ Ù‡Ø¯Ù Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ± (ÙŠÙØ¶Ù‘Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Arrival_Timestamp)
    function serverEtaMsFromSnapshot(v){
      // 1) Arrival_Timestamp (ms Ø£Ùˆ s Ø£Ùˆ ISO)
      if(v && v.Arrival_Timestamp != null){
        if(typeof v.Arrival_Timestamp === 'number'){
          var n = v.Arrival_Timestamp;
          var ms = (n > 1e12) ? n : n*1000; // Ù„Ùˆ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ø­ÙˆÙ‘Ù„ Ù„Ù…ÙŠÙ„Ù‘ÙŠ
          return ms + EXTRA_SECONDS*1000;   // Ø£Ø¶Ù +3 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
        }
        if(typeof v.Arrival_Timestamp === 'string'){
          var t = Date.parse(v.Arrival_Timestamp);
          if(!isNaN(t)) return t + EXTRA_SECONDS*1000;
        }
      }
      // 2) Ø£Ù†ÙƒØ§Ù†ÙØª/Ù…Ø¯Ø© Ø®Ø§Ù…Ø© Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ (fallback Ø£Ø¶Ø¹Ù Ø¯Ù‚Ø© Ù„Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ø¹Ø±Ù ÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³)
      if(v && typeof v.Ankunft_Seconds_Raw === 'number'){
        return nowServerMs() + (v.Ankunft_Seconds_Raw + EXTRA_SECONDS)*1000;
      }
      // 3) DurationValue (Ø§Ù„Ø£Ø¶Ø¹Ù)
      if(v && typeof v.DurationValue === 'number'){
        return nowServerMs() + (v.DurationValue + EXTRA_SECONDS)*1000;
      }
      return null;
    }

    // Ø³ÙŠØ§Ø³Ø© Ø¹Ø¯Ù…-Ø§Ù„Ø²ÙŠØ§Ø¯Ø©: Ù„Ø§ Ù†Ø³Ù…Ø­ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‡Ø¯Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ØŒ Ù†Ø³Ù…Ø­ ÙÙ‚Ø· Ø¨Ø§Ù„ØªØ­Ø³Ù‘Ù† (>15s Ø£Ø¨ÙƒØ±)
    var ETA_IMPROVE_THRESHOLD_MS = 15000; // 15 Ø«Ø§Ù†ÙŠØ©
    function updateEtaNoIncrease(newEtaMs){
      if(newEtaMs == null) return;
      if(etaTargetMs == null){
        saveEtaTarget(newEtaMs);
        startOrUpdateCountdownFromTarget();
        return;
      }
      var diff = newEtaMs - etaTargetMs; // Ù…ÙˆØ¬Ø¨ = ØªØ£Ø®ÙŠØ±ØŒ Ø³Ø§Ù„Ø¨ = ØªØ­Ø³Ù‘Ù†
      if(diff < -ETA_IMPROVE_THRESHOLD_MS){
        // ØªØ­Ø³Ù‘Ù† ÙˆØ§Ø¶Ø­: Ù†Ø­Ø¯Ù‘Ø« Ù„Ù„Ø£Ø³ÙˆØ£ØŸ Ù„Ø§ØŒ Ù„Ù„Ø£Ø³ÙØ±Ø¹ (newEtaMs Ø£Ø¨ÙƒØ±)
        saveEtaTarget(newEtaMs);
        startOrUpdateCountdownFromTarget();
      }
      // Ø¥Ù† ÙƒØ§Ù† diff >= -15s Ù„Ø§ Ù†ØºÙŠÙ‘Ø± (ÙˆØ¨Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ø§ ÙŠØ²ÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙŠÙ„ÙˆØ¯)
    }

    function startOrUpdateCountdownFromTarget(){
      if(!deliveryActive || !etaTargetMs) return;
      if(countdownTimer) clearInterval(countdownTimer);

      function tick(){
        var rem = Math.floor((etaTargetMs - nowServerMs())/1000);
        remaining = Math.max(0, rem);
        if(remaining === 60 && !oneMinuteWarned){
          oneMinuteWarned = true;
          autoSound("soundOneMinute");
        }
        renderCountdown();
        if(remaining <= 0){
          clearInterval(countdownTimer); countdownTimer=null;
        }
      }
      tick();
      countdownTimer = setInterval(tick, 1000);
    }

    function renderCountdown(){
      if(remaining==null){ countdownEl.textContent="â€”"; return; }
      var m=Math.floor(remaining/60), s=remaining%60;
      countdownEl.textContent = m + ":" + (s<10?("0"+s):s);
    }

    function routeIfNeeded(origin, destination){
      if(!origin||!destination) return;
      directionsService.route({
        origin: origin, destination: destination, travelMode: 'DRIVING'
      }, function(result, status){
        if(status==='OK'){ directionsRenderer.setDirections(result); }
      });
    }

    /* ================= initMap ================= */
    function initMap(){
      distanceEl  = document.getElementById("distance");
      countdownEl = document.getElementById("countdown");

      map = new google.maps.Map(document.getElementById("map"), { zoom:14, center:{lat:52.52, lng:13.40} });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers:true,
        polylineOptions:{ strokeColor:"#4285F4", strokeOpacity:0.8, strokeWeight:2 }
      });
      directionsRenderer.setMap(map);

      var params = new URLSearchParams(window.location.search);
      orderId = params.get("orderId");
      if(!orderId){ alert("âš  Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± orderId ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·"); return; }

      // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù‡Ø¯Ù Ø³Ø§Ø¨Ù‚ (Ø¥Ù† ÙˆÙØ¬Ø¯) Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
      loadEtaTarget();

      var ref = db.ref("orders/" + orderId);
      ref.on("value", function(snap){
        var v = snap.val();
        if(!v) return;

        if(v.DistanceText) distanceEl.textContent = v.DistanceText;

        // Ø§Ù„Ø­Ø§Ù„Ø©
        var cur = normalizeStatus(v.Status);
        if(cur === "unterwegs" && prevStatusNorm !== "unterwegs"){
          deliveryActive = true;

          // ğŸ”Š ØµÙˆØª Ø§Ù„Ù‚Ø¨ÙˆÙ„ ÙÙˆØ±Ù‹Ø§
          autoSound("soundAccept");

          // Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙ‘Ù„ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©:
          var firstEta = serverEtaMsFromSnapshot(v);
          if(etaTargetMs){
            // ÙƒØ§Ù† Ù„Ø¯ÙŠÙ†Ø§ Ù‡Ø¯Ù Ø³Ø§Ø¨Ù‚ (Ù…Ø«Ù„Ø§Ù‹ Ø¨Ø¹Ø¯ Ø±ÙŠÙ„ÙˆØ¯) â€” Ù„Ø§ Ù†Ø²ÙŠØ¯Ù‡
            updateEtaNoIncrease(firstEta);
          }else{
            // Ù„Ø§ Ù‡Ø¯Ù Ù…Ø­ÙÙˆØ¸ â€” Ø§Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„ Ù‚ÙŠÙ…Ø©
            updateEtaNoIncrease(firstEta);
          }
          startOrUpdateCountdownFromTarget();

        } else if(cur === "bearbeitung" && prevStatusNorm !== "bearbeitung"){
          deliveryActive = false;
          resetCountdownUI();
        }
        prevStatusNorm = cur;

        // Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³ÙŠØ±: Ù†Ù„ØªØ²Ù… Ø¨Ø¹Ø¯Ù… Ø§Ù„Ø²ÙŠØ§Ø¯Ø© â€” Ù†Ø³Ù…Ø­ ÙÙ‚Ø· Ø¨Ø§Ù„ØªØ­Ø³Ù‘Ù†
        if(deliveryActive){
          var liveEta = serverEtaMsFromSnapshot(v);
          updateEtaNoIncrease(liveEta);
        }

        // Ù…ÙˆØ§Ù‚Ø¹ + Ø±Ø³Ù…
        var dest = parseLatLng(v.Destination);
        var drv  = parseLatLng(v.DriverLocation);

        if(dest){
          if(!destMarker){
            destMarker = new google.maps.Marker({
              position: dest, map: map,
              icon: { url: "7720549.png", scaledSize: new google.maps.Size(28,28), anchor: new google.maps.Point(14,28) },
              title: "Ø§Ù„Ù…Ø·Ø¹Ù… / Ø§Ù„ÙˆØ¬Ù‡Ø©"
            });
          } else destMarker.setPosition(dest);
        }
        if(drv){
          if(!driverMarker){
            driverMarker = new google.maps.Marker({
              position: drv, map: map,
              icon: { url: "710491-200.png", scaledSize: new google.maps.Size(28,28), anchor: new google.maps.Point(14,28) },
              title: "Ø§Ù„Ø³Ø§Ø¦Ù‚"
            });
          } else driverMarker.setPosition(drv);
          map.panTo(drv);
        }
        if(dest && drv){
          if(!fitOnce){
            var b=new google.maps.LatLngBounds(); b.extend(dest); b.extend(drv); map.fitBounds(b); fitOnce=true;
          }
          routeIfNeeded(drv, dest);
        }
      });
    }
    window.initMap = initMap;
  </script>

  <!-- Google Maps -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDipzUmxEQmAjaDkn6xQ91ZhqnkPmgl-2o&loading=async&callback=initMap"></script>
</body>

</html>


